#!/usr/bin/env ruby

require 'bundler/setup'
require 'require_all'
require_all 'lib'

require 'yaml'
require 'pp'

USAGE = "Usage: assign <config_file.yml>"

def debug(obj)
  p obj if ENV["DEBUG"]
end

def main(args)
  config_file = args.first
  abort USAGE unless config_file
  config = YAML.load_file(config_file)

  people = config["people"].map {|ea| Person.from(ea) }
  exclusions = Exclusion.from_groups(people, config["exclusion_groups"])
  exclusions.each do |k, v|
    debug "#{k}: not #{v.to_a.map {|ea| ea.name }.join(', ')}"
  end

  matcher = Matcher.new(people, exclusions)
  assignments = matcher.match
  assignments.each do |giver, recipient|
    debug "#{giver.name} => #{recipient.name}"
  end

  obscured_assignments = Obfuscator.obfuscate(people, assignments)
  File.open("assignments_#{Time.now.to_i}.yml", "w") do |file|
    file.write(YAML.dump(obscured_assignments))
  end
end

main(ARGV) if $PROGRAM_NAME == __FILE__
